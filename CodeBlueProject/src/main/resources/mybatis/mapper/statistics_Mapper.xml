<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.cpr.admin.mapper.IStatsMapper">
	
	<resultMap type="kr.or.ddit.cpr.vo.StatsVO" id="statsMap">
		<result property="yearMonth" column="YYYY"/>
		<result property="typeCode" column="REG_TYPE"/>
		<result property="typeName" column="TYPE_NAME"/>
		<result property="cnt" column="CNT"/>
		<result property="amount" column="AMOUNT"/>
	</resultMap>
	
	<!--
		통계 - 연도별 월간 외래/입원 환자 추이 및 실제 매출 현황 통계 
		테이블 : REGISTRATION (외래 일자), ADMISSION (입원 일자), BILLS(외래or입원 구분), PAYMENT(수납)
		의도 : 업무량과 매출의 집계 기준을 분리함 (진료일과 진료에 대한 실제 수납일을 분리하여 계산)
		즉, 이번 달에 얼마나 많은 환자가 왔는지 / 실제로 얼마의 수익이 들어왔는지 정확한 파악이 가능하도록 구현
	-->
	<select id="selectYearsStats" resultMap="statsMap">
		SELECT j.YYYY
			 , j.REG_TYPE
			 , j.TYPE_NAME
			 , NVL(k.cnt, 0) CNT
			 , NVL(k.AMOUNT, 0) AMOUNT
		  from (
		  	   select a.YYYY, b.REG_TYPE, b.TYPE_NAME
		  	     from (
		  	     	   SELECT #{year} || '-' || LPAD(level, 2, '0') YYYY
		  	     	     FROM dual
		  	     	  CONNECT BY level <![CDATA[<=]]> 12
		  	     ) a,
		  	     (
		  	     	   SELECT 'A0001' REG_TYPE, '외래' TYPE_NAME FROM dual
		  	     	    UNION ALL
		  	     	   SELECT 'A0002' REG_TYPE, '입원' TYPE_NAME FROM dual
		  	     ) b
		  	  ) j
		  	    LEFT JOIN (
		  	        SELECT YM STD_DATE
		  	         	 , REG_TYPE
		  	         	 , SUM(CNT) CNT
		  	         	 , SUM(AMOUNT) AMOUNT
		            FROM (
		                <!-- 1) 업무량(환자수): 진료일/입원일 기준 (돈 안 내도 카운트 됨) -->
		                SELECT TO_CHAR(r.registration_regdate, 'YYYY-MM') YM
		                       , 'A0001' reg_type
		                       , 1 CNT
		                       , 0 AMOUNT
		                  FROM REGISTRATION r
		                 UNION ALL
		                SELECT TO_CHAR(a.admission_date, 'YYYY-MM') YM
		                	   , 'A0002' reg_type
			                   , 1 CNT
			                   , 0 AMOUNT
		                  FROM ADMISSION a
		                 UNION ALL
		              <!-- 2) 매출(금액): 실제 결제일(p.DATE) 기준 (진료일 상관없이 돈 들어온 날) -->
		                SELECT TO_CHAR(p.PAYMENT_DATE, 'YYYY-MM') YM,
		                  CASE WHEN b.REGISTRATION_NO IS NOT NULL THEN 'A0001' <!-- 외래 -->
		                       WHEN b.ADMISSION_NO IS NOT NULL THEN 'A0002'    <!-- 입원 -->
		                   END REG_TYPE
		                     , 0 CNT
		                     , NVL(p.payment_amount, 0) AMOUNT
		                  FROM PAYMENT p
		                  JOIN bills b ON b.BILL_NO = p.BILL_NO
		                 WHERE p.payment_status = 'Y' <!-- 결제 완료된 건만 집계 -->
		                   AND (b.registration_no IS NOT NULL OR b.admission_no IS NOT NULL)
		            ) GROUP BY YM, REG_TYPE
		        ) k
		        ON j.YYYY = k.STD_DATE
		        AND j.REG_TYPE = k.REG_TYPE
		        ORDER BY j.YYYY, j.REG_TYPE
	</select>
	
	<select id="selectDemographicsStats" resultMap="statsMap">
		SELECT
		  CASE
		  WHEN t.AGE_GROUP >= 80 THEN '80대 이상'
		  ELSE TO_CHAR(t.AGE_GROUP) || '대'
		   END AS YYYY,
	  t.GENDER AS REG_TYPE,
	 '성별·연령' AS TYPE_NAME,
	  COUNT(*) AS CNT,
			0  AS AMOUNT
		FROM (
      SELECT
          CASE
              WHEN SUBSTR(p.PATIENT_REGNO2, 1, 1) IN ('1','3','5','7') THEN '남성'
              WHEN SUBSTR(p.PATIENT_REGNO2, 1, 1) IN ('2','4','6','8') THEN '여성' ELSE '오류'
          END AS GENDER,
          TRUNC(
            FLOOR(
              MONTHS_BETWEEN(
                TO_DATE(#{year} || '1231','YYYYMMDD'),
                TO_DATE(
                  CASE
                    WHEN SUBSTR(p.PATIENT_REGNO2, 1, 1) IN ('9','0') THEN '18'
                    WHEN SUBSTR(p.PATIENT_REGNO2, 1, 1) IN ('1','2','5','6') THEN '19'
                    WHEN SUBSTR(p.PATIENT_REGNO2, 1, 1) IN ('3','4','7','8') THEN '20'
                    ELSE '19'
                  END || SUBSTR(p.PATIENT_REGNO1, 1, 6),
                  'YYYYMMDD'
                )
              ) / 12
            ) / 10
          ) * 10 AS AGE_GROUP
          
		      FROM PATIENT p
		      INNER JOIN (
		          SELECT DISTINCT patient_no
		            FROM REGISTRATION
		           WHERE REGISTRATION_REGDATE >= TO_DATE(#{year} || '0101','YYYYMMDD')
		             AND REGISTRATION_REGDATE &lt; TO_DATE(#{year} + 1 || '0101','YYYYMMDD')
		          UNION
		          SELECT DISTINCT patient_no
		            FROM ADMISSION
		           WHERE ADMISSION_DATE >= TO_DATE(#{year} || '0101','YYYYMMDD')
		             AND ADMISSION_DATE &lt; TO_DATE(#{year} + 1 || '0101','YYYYMMDD')
		      ) v ON v.PATIENT_NO = p.PATIENT_NO
		  ) t
		  GROUP BY t.AGE_GROUP, t.GENDER
		  ORDER BY
		      t.AGE_GROUP ASC,
		      CASE t.GENDER WHEN '남성' THEN 1 WHEN '여성' THEN 2 ELSE 3 END
	</select>
	
	<select id="selectDailyPatientStats" resultMap="statsMap">
		SELECT TO_CHAR(base.visit_day, 'MM.DD') YYYY,
		      '신규환자' TYPE_NAME,
		       COUNT(*) CNT,
		      'NEW' REG_TYPE,
		       0 AMOUNT
		FROM (
		    <!-- 이번 달 방문자 + 최초 방문일 계산을 한번에 묶음 -->
		    SELECT today_visit.visit_day,
		      CASE WHEN today_visit.visit_day = first_visit.first_day THEN 'NEW' 
		           ELSE 'OLD' 
		       END type_code
		      FROM 
				<!-- 이번 달 방문한 환자들 (중복제거) -->
		        (SELECT DISTINCT 
		                patient_no, 
		                TRUNC(REGISTRATION_REGDATE) visit_day
		           FROM REGISTRATION
		          WHERE REGISTRATION_REGDATE >= TO_DATE(#{year} || LPAD(#{month},2,'0') || '01', 'YYYYMMDD')
		            AND REGISTRATION_REGDATE &lt;  ADD_MONTHS(TO_DATE(#{year} || LPAD(#{month},2,'0') || '01', 'YYYYMMDD'), 1)) today_visit
		    	   JOIN
				<!-- 환자별 생애 최초 방문일 -->
		        (SELECT patient_no, 
		                   MIN(TRUNC(REGISTRATION_REGDATE)) first_day
		            FROM REGISTRATION
		            GROUP BY patient_no) first_visit
		    ON today_visit.patient_no = first_visit.patient_no) base
		 WHERE base.type_code = 'NEW'
		 GROUP BY base.visit_day
		
		 UNION ALL
		
		SELECT TO_CHAR(base.visit_day, 'MM.DD') YYYY,
		      '재방문환자' TYPE_NAME,
		       COUNT(*) CNT,
		      'OLD' REG_TYPE,
		       0 AMOUNT
		  FROM (SELECT today_visit.visit_day,
		          CASE WHEN today_visit.visit_day = first_visit.first_day THEN 'NEW' 
		          ELSE 'OLD' 
		           END type_code
		  FROM (SELECT DISTINCT 
	                   patient_no, 
	                   TRUNC(REGISTRATION_REGDATE) visit_day
	              FROM REGISTRATION
	             WHERE REGISTRATION_REGDATE >= TO_DATE(#{year} || LPAD(#{month},2,'0') || '01', 'YYYYMMDD')
	               AND REGISTRATION_REGDATE &lt;  ADD_MONTHS(TO_DATE(#{year} || LPAD(#{month},2,'0') || '01', 'YYYYMMDD'), 1)) today_visit
		  JOIN (SELECT patient_no, 
		               MIN(TRUNC(REGISTRATION_REGDATE)) first_day
		          FROM REGISTRATION
	             GROUP BY patient_no) first_visit
	      		    ON today_visit.patient_no = first_visit.patient_no) base
				 WHERE base.type_code = 'OLD'
		  		 GROUP BY base.visit_day
			     ORDER BY YYYY ASC, REG_TYPE ASC
	</select>
</mapper>