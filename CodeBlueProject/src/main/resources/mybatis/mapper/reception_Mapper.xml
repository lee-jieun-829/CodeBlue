<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.cpr.billing.mapper.IReceptionMapper">
	
	<resultMap type="kr.or.ddit.cpr.vo.PatientVO" id="patientMap">
		<id property="patientNo" column="patient_no"/>
		<result property="patientName" column="patient_name"/>
		<result property="patientRegno1" column="patient_regno1"/>
		<result property="patientRegno2" column="patient_regno2"/>
		<result property="patientTel" column="patient_tel"/>
		<result property="patientAddr1" column="patient_addr1"/>
		<result property="patientAddr2" column="patient_addr2"/>
		<result property="patientEmail" column="patient_email"/>
		<result property="patientGen" column="patient_gen"/>
		<result property="patientAge" column="patientAge"/>
		<result property="patientMemo" column="patient_memo"/>
		<result property="patientPostcode" column="patient_postcode"/>
		<result property="employeeName" column="employee_name"/>
		<result property="currentStatus" column="currentStatus"/>
		<association property="registrationVO" resultMap="registrationMap"/>
	</resultMap>
	
	<resultMap type="kr.or.ddit.cpr.vo.RegistrationVO" id="registrationMap">
		<id property="registrationNo" column="registration_no"/>
		<result property="registrationVisittype" column="registration_visittype"/>
		<result property="registrationInsurance" column="registration_insurance"/>
		<result property="registrationRegdate" column="registration_regdate"/>
		<result property="registrationStatus" column="registration_status"/>
		<result property="locationNo" column="location_no"/>
		<result property="patientNo" column="patient_no"/>
		<result property="employeeNo" column="employee_no"/>
		<result property="reservationYn" column="reservation_yn"/>
    	<result property="reservationTime" column="reservation_time"/>
	</resultMap>
	
	<!-- 신규 환자 정보 등록 -->
	<insert id="insertPatient" parameterType="kr.or.ddit.cpr.vo.PatientVO">
		<selectKey keyProperty="patientNo" resultType="int" order="BEFORE">
			select seq_patient.nextval from dual
		</selectKey>
		INSERT INTO patient (
		      patient_no
		    , patient_name
		    , patient_regno1
		    , patient_regno2
		    , patient_tel
		    , patient_addr1
		    , patient_email
		    , patient_gen
		    , patient_memo
		    , patient_addr2
		    , patient_postcode
		) VALUES (
		      #{patientNo}
		    , #{patientName}
		    , #{patientRegno1}
		    , #{patientRegno2}
		    , #{patientTel}
		    , #{patientAddr1}
		    , #{patientEmail}
		    , #{patientGen}
		    , #{patientMemo}
		    , #{patientAddr2}
		    , #{patientPostcode}
		)
	</insert>
	
	<!-- 신규 환자 중복 체크 -->
	<select id="selectPatientDuplicate" parameterType="kr.or.ddit.cpr.vo.PatientVO" resultType="int">
	    SELECT COUNT(*)
	    FROM patient
	    WHERE patient_name = #{patientName}
	      AND patient_regno1 = #{patientRegno1}
	      AND patient_regno2 = #{patientRegno2}
	</select>
	
	<!-- 신규, 외래(재진) 접수 등록 -->
	<insert id="insertRegistration" parameterType="kr.or.ddit.cpr.vo.RegistrationVO">
		<selectKey keyProperty="registrationNo" resultType="int" order="BEFORE">
			select seq_registration.nextval from dual
		</selectKey>
		INSERT INTO registration (
		      registration_no
		    , registration_visittype
		    , registration_insurance
		    , registration_regdate
		    , registration_status
		    , location_no
		    , patient_no
		    , employee_no
		) VALUES (
		      #{registrationNo}
		    , #{registrationVisittype}
		    , #{registrationInsurance}
		    , SYSDATE
		    , '001'
		    , #{locationNo}
		    , #{patientNo}
		    , #{employeeNo}
		)
	</insert>
	
	<!-- 대기 환자 조회 -->
	<select id="selectWaitingList" resultMap="patientMap">
		SELECT 
		      p.patient_no
		    , p.patient_name
		    , p.patient_gen
		    , p.patient_regno1
		    , p.patient_regno2
		    , p.patient_gen
		    , (EXTRACT(YEAR FROM SYSDATE) - 
			    (CASE WHEN SUBSTR(p.patient_regno2, 1, 1) IN ('1','2','5','6') THEN '19' 
			          WHEN SUBSTR(p.patient_regno2, 1, 1) IN ('3','4','7','8') THEN '20'
			          ELSE '19' 
			     END || SUBSTR(p.patient_regno1, 1, 2)) + 1) AS patientAge
		    , r.registration_no
		    , r.registration_visittype
		    , r.registration_insurance
		    , TO_CHAR(r.registration_regdate, 'YYYY-MM-DD HH24:MI') AS registration_regdate
		    , r.registration_status
		    , r.location_no
		    , r.employee_no
		    /*, NVL2(s.schedule_no, 'Y', NVL(r.reservation_yn, 'N')) AS reservation_yn*/
		    /* 예약 여부 판단: 일정 테이블에 데이터가 있으면 Y */
        	, CASE WHEN s.schedule_no IS NOT NULL THEN 'Y' ELSE NVL(r.reservation_yn, 'N') END AS reservation_yn
	        /* 진료 일정(002) 데이터에서 시간 가져옴 */
	        , TO_CHAR(s.schedule_start, 'HH24:MI') AS reservation_time
		    , e.employee_name
		FROM patient p
		INNER JOIN registration r ON p.patient_no = r.patient_no
		LEFT JOIN employee e ON r.employee_no = e.employee_no
		/* 예약 진료일정(002) 필터링 */
	    LEFT JOIN schedule s ON (
                             r.patient_no = s.patient_no
                         AND r.employee_no = s.SCHEDULE_DOCTOR_NO 
                         AND s.schedule_type = '002' 
                         AND TRUNC(s.schedule_start) = TRUNC(SYSDATE)
                        )
	    WHERE r.registration_status IN ('001', '002', '003')
	    	AND TRUNC(r.registration_regdate) = TRUNC(SYSDATE)
	    ORDER BY 
	        r.reservation_yn DESC,           /* 예약 환자 우선 */
	        s.schedule_start ASC,            /* 예약 시간 빠른 순 */
	        r.registration_regdate ASC       /* 접수 시간 빠른 순 */
	</select>
	
	<!-- 외래 접수 환자 검색 -->
	<select id="selectPatientList" parameterType="string" resultMap="patientMap">
	    SELECT 
		      p.patient_no
		    , p.patient_name
		    , p.patient_regno1
		    , p.patient_tel
		    , p.patient_memo
		    , (
	            /* 외래 상태와 입원 상태 중 우선순위가 높은 것을 가져옴 */
	            SELECT status FROM (
	                /* 1순위: 입원 중이면 'ADMIT' 표시 */
	                SELECT 'ADMIT' as status, 1 as priority FROM admission 
	                WHERE patient_no = p.patient_no AND admission_status = '001'
	                UNION ALL
	                /* 2순위: 최근 외래 접수 상태 */
	                SELECT registration_status, 2 FROM registration 
	                WHERE patient_no = p.patient_no 
	                ORDER BY priority ASC, 1 DESC
	            ) WHERE ROWNUM = 1
	          ) AS currentStatus
		    , (
	            /* 오늘 날짜의 외래 예약(002)이 있으면 해당 의사 번호를 1순위로, 없으면 마지막 진료 의사를 2순위로 가져옴 */
	            SELECT NVL(
	                (SELECT SCHEDULE_DOCTOR_NO FROM schedule 
	                 WHERE patient_no = p.patient_no AND schedule_type = '002' AND TRUNC(schedule_start) = TRUNC(SYSDATE) AND ROWNUM = 1),
	                (SELECT employee_no FROM (SELECT employee_no FROM registration WHERE patient_no = p.patient_no ORDER BY registration_regdate DESC) WHERE ROWNUM = 1)
	            ) FROM DUAL
	          ) AS employee_no
        	, (
        		SELECT r.location_no 
        		FROM (SELECT * FROM registration 
        			WHERE patient_no = p.patient_no 
        			ORDER BY registration_regdate DESC) r 
        	WHERE ROWNUM = 1) AS location_no  
		FROM patient p
		WHERE p.patient_name LIKE '%' || #{keyword} || '%'  
			  OR TO_CHAR(p.patient_no) = #{keyword}
	</select>
	
	<!-- 입원 접수 환자 검색 -->
	<select id="selectInpatientSearch" parameterType="string" resultMap="patientMap">
	   SELECT 
			  p.patient_no
			/* 오늘 입원 예약(schedule_type='003')이 있으면 이름 뒤에 (예약) 표시 */
	        , CASE 
	            WHEN s.schedule_no IS NOT NULL THEN p.patient_name || ' (예약)'
	            ELSE p.patient_name 
	          END AS patient_name
			, p.patient_regno1
			, p.patient_tel
			, p.patient_memo
			, r.registration_no
			/* 외래 담당의가 없으면 예약 시 담당의(SCHEDULE_DOCTOR_NO)를 기본값으로 사용 */
	        , NVL(r.employee_no, s.SCHEDULE_DOCTOR_NO) AS employee_no
			, (
				SELECT employee_name 
				FROM employee 
				WHERE employee_no = r.employee_no
			  ) AS employee_name
			, r.location_no
			, r.registration_status
		FROM patient p
		JOIN registration r ON p.patient_no = r.patient_no
		/* 담당의 일치 조건 없이 환자번호와 오늘 날짜로만 일정 테이블 조인 */
	    LEFT JOIN schedule s ON (
		    	p.patient_no = s.patient_no 
		    AND s.schedule_type = '003' 
		    AND s.SCHEDULE_DOCTOR_NO = r.employee_no
		    AND s.schedule_start >= TRUNC(SYSDATE) /* 오늘부터 미래 예약 포함 */
		)
		WHERE (
				p.patient_name LIKE '%' || #{keyword} || '%' 
				OR TO_CHAR(p.patient_no) = #{keyword}
			  )
		  AND r.registration_status IN ('001', '002', '003', '004', '005') 
		  /*AND r.registration_regdate >= TRUNC(SYSDATE)*/
		  AND p.patient_no NOT IN (
			  SELECT patient_no 
			  FROM admission 
			  WHERE admission_status = '001'
		  )
		ORDER BY r.registration_regdate DESC
	</select>
	
	<!-- 입원접수 정보 등록 -->
	<insert id="insertAdmission" parameterType="kr.or.ddit.cpr.vo.AdmissionVO">
	    <selectKey keyProperty="admissionNo" resultType="int" order="BEFORE">
	    	select seq_admission.nextval from dual
	    </selectKey>
	    INSERT INTO admission (
		      admission_no
		    , patient_no
		    , bed_no
		    , employee_no
		    , admission_insurance
		    , admission_visittype
		    , admission_status
		    , admission_date
		) VALUES (
		      #{admissionNo}
		    , #{patientNo}
		    , #{bedNo}
		    , #{employeeNo}
		    , #{admissionInsurance}
		    , #{admissionVisittype}
		    , #{admissionStatus}
		    , SYSDATE
		)
	</insert>
	
	<!-- 선택한 침상 상태 변경 -->
	<update id="updateBedStatusOccupied" parameterType="int">
	    UPDATE bed
		   SET bed_status = '002'
		 WHERE bed_no = #{bedNo}
	</update>
	
	<!-- 병상 전체 목록 조회 -->
	<select id="selectBedList" resultType="kr.or.ddit.cpr.vo.BedVO">
	    SELECT 
          b.bed_no
        , b.room_no
        , CASE 
            /* 환자 상태가 입원중(001) 또는 퇴원대기(002)이면 -> 사용중(002) */
            WHEN EXISTS (
                SELECT 1 FROM admission a 
                WHERE a.bed_no = b.bed_no 
                  AND a.admission_status IN ('001', '002')
            ) THEN '002'
            
            /* 환자 상태가 퇴원수납대기(003)이거나, 아예 입원 기록이 없으면 -> 사용가능(001) */
            ELSE '001'
          END AS bed_status
    FROM bed b
		ORDER BY bed_no ASC
	</select>
	
	<!-- 차트 생성 -->
	<insert id="insertChart" parameterType="kr.or.ddit.cpr.vo.ChartVO">
		<selectKey keyProperty="chartNo" resultType="int" order="BEFORE">
			select seq_chart.nextval from dual
		</selectKey>
		INSERT INTO chart (
		      chart_no
		    , chart_regdate
		    , employee_no
		    , patient_no
		    , admission_no
		    , registration_no
		) VALUES (
		      #{chartNo}
		    , SYSDATE
		    , #{employeeNo}
		    , #{patientNo}
		    , <choose>
		        <when test="admissionNo != 0">#{admissionNo}</when>
		        <otherwise>NULL</otherwise>
		      </choose>
		    , <choose>
		        <when test="registrationNo != 0">#{registrationNo}</when>
		        <otherwise>NULL</otherwise>
		      </choose>
		)
	</insert>
	
	<!-- 환자 메모 수정 -->
	<update id="updatePatientMemo" parameterType="kr.or.ddit.cpr.vo.PatientVO">
	    UPDATE patient
		   SET patient_memo = #{patientMemo}
		 WHERE patient_no = #{patientNo}
	</update>
	
	<!-- 접수 시 의사 조회 - 재직(001) -->
	<select id="selectDoctorList" resultType="kr.or.ddit.cpr.vo.EmployeeVO">
	    SELECT 
	          a.employee_no
	        , a.employee_name
	        , b.location_no as employeeDetailLicence  /* 임시로 안쓰는 필드에 숫자 번호 저장 */
        	, b.location_name as locationNo          /* 표시용 이름 */
	    FROM employee a
	    LEFT OUTER JOIN location b ON (a.employee_no = b.employee_no)
	    WHERE a.employee_code = '1'       
	    	AND a.employee_status = '001'    
	    ORDER BY b.location_no ASC NULLS LAST, a.employee_name ASC
	</select>
</mapper>