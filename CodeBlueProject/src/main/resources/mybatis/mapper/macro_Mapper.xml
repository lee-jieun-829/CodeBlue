<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.cpr.macro.mapper.IMacroMapper">

    <resultMap type="kr.or.ddit.cpr.vo.MacroVO" id="macroMap">
        <result property="macroNo" column="MACRO_NO"/>
        <result property="macroName" column="MACRO_NAME"/>
        <result property="macroType" column="MACRO_TYPE"/>
        <result property="macroContent" column="MACRO_CONTENT"/>
        <result property="macroRegdate" column="MACRO_REGDATE"/>
        <result property="employeeNo" column="EMPLOYEE_NO"/>
        <result property="macroYn" column="MACRO_YN"/> <collection property="macroDetails" resultMap="macroDetailMap"></collection>
    </resultMap>
    
    <resultMap type="kr.or.ddit.cpr.vo.MacroDetailVO" id="macroDetailMap">
        <result property="macroDetailNo" column="MACRO_DETAIL_NO"/>
        <result property="macroDetailType" column="MACRO_DETAIL_TYPE"/>
        <result property="macroDetailPrename" column="MACRO_DETAIL_PRENAME"/>
        <result property="macroNo" column="MACRO_NO"/>
    </resultMap>

    <select id="selectMacroList" parameterType="int" resultType="kr.or.ddit.cpr.vo.MacroVO">
        SELECT 
            MACRO_NO       AS macroNo,
            MACRO_NAME     AS macroName,
            MACRO_TYPE     AS macroType,
            MACRO_CONTENT  AS macroContent,
            MACRO_REGDATE  AS macroRegdate,
            EMPLOYEE_NO    AS employeeNo,
            MACRO_YN       AS macroYn     
        FROM MACRO
        WHERE 1=1
        <if test="employeeNo != 0">
            AND EMPLOYEE_NO = #{employeeNo}
        </if>
        ORDER BY MACRO_NO DESC
    </select>

    <select id="selectMacro" parameterType="int" resultMap="macroMap">
        SELECT 
            m.MACRO_NO,
            m.MACRO_NAME,
            m.MACRO_TYPE,
            m.MACRO_CONTENT,
            m.MACRO_REGDATE,
            m.EMPLOYEE_NO,
            m.MACRO_YN,
            d.MACRO_DETAIL_NO,
            d.MACRO_DETAIL_TYPE,
            d.MACRO_DETAIL_PRENAME
        FROM MACRO m
        LEFT OUTER JOIN MACRO_DETAIL d ON m.MACRO_NO = d.MACRO_NO
        WHERE m.MACRO_NO = #{macroNo}
    </select>

    <insert id="insertMacro" parameterType="kr.or.ddit.cpr.vo.MacroVO">
        <selectKey keyProperty="macroNo" resultType="int" order="BEFORE">
            SELECT SEQ_MACRO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO MACRO (
            MACRO_NO, 
            MACRO_NAME,
            MACRO_TYPE,
            MACRO_CONTENT,
            EMPLOYEE_NO,
            MACRO_YN,      
            MACRO_REGDATE
        ) VALUES (
            #{macroNo},
            #{macroName},
            #{macroType},
            #{macroContent},
            #{employeeNo},
            #{macroYn},    
             SYSDATE
        )
    </insert>

    <insert id="insertMacroDetail" parameterType="map">
        INSERT INTO MACRO_DETAIL (
            MACRO_DETAIL_NO,
            MACRO_NO,
            MACRO_DETAIL_TYPE,
            MACRO_DETAIL_PRENAME  
        ) VALUES (
            SEQ_MACRO_DETAIL.NEXTVAL,
            #{macroNo},
            #{type},
            #{code}               
        )
    </insert>

    <update id="updateMacro" parameterType="kr.or.ddit.cpr.vo.MacroVO">
        UPDATE MACRO
        SET
            MACRO_NAME = #{macroName},
            MACRO_TYPE = #{macroType},
            MACRO_CONTENT = #{macroContent},
            MACRO_REGDATE = SYSDATE
        WHERE MACRO_NO = #{macroNo}
    </update>

    <delete id="deleteMacro" parameterType="int">
        DELETE FROM MACRO WHERE MACRO_NO = #{macroNo}
    </delete>

    <delete id="deleteMacroDetail" parameterType="int">
        DELETE FROM MACRO_DETAIL WHERE MACRO_NO = #{macroNo}
    </delete>

    <select id="selectDiagnosisList" parameterType="String" resultType="kr.or.ddit.cpr.vo.DiagnosisVO">
        SELECT 
            DIAGNOSIS_NO   AS diagnosisNo,
            DIAGNOSIS_CODE AS diagnosisCode,
            DIAGNOSIS_NAME AS diagnosisName
        FROM DIAGNOSIS
        WHERE DIAGNOSIS_CODE LIKE '%' || #{keyword} || '%' 
           OR DIAGNOSIS_NAME LIKE '%' || #{keyword} || '%'
        ORDER BY DIAGNOSIS_CODE ASC
    </select>

    <select id="selectDrugList" parameterType="String" resultType="kr.or.ddit.cpr.vo.DrugVO">
        SELECT 
            DRUG_NO      AS drugNo,
            DRUG_CODE    AS drugCode,
            DRUG_NAME    AS drugName,
            DRUG_COMPANY AS drugCompany,
            DRUG_TYPE    AS drugType,
            DRUG_SPEC    AS drugSpec,
            DRUG_UNIT    AS drugUnit,
            DRUG_PRICE   AS drugPrice
        FROM DRUG
        WHERE DRUG_CODE LIKE '%' || #{keyword} || '%' 
           OR DRUG_NAME LIKE '%' || #{keyword} || '%'
        ORDER BY DRUG_NAME ASC
    </select>

    <select id="selectTreatmentList" parameterType="String" resultType="kr.or.ddit.cpr.vo.TreatmentVO">
        SELECT 
            TREATMENT_NO    AS treatmentNo,
            TREATMENT_CODE  AS treatmentCode,
            TREATMENT_NAME  AS treatmentName,
            TREATMENT_PRICE AS treatmentPrice
        FROM TREATMENT
        WHERE TREATMENT_CODE LIKE '%' || #{keyword} || '%' 
           OR TREATMENT_NAME LIKE '%' || #{keyword} || '%'
        ORDER BY TREATMENT_NAME ASC
    </select>
    
    <select id="selectNurseMacroList" parameterType="map" resultType="kr.or.ddit.cpr.vo.MacroVO">
        SELECT 
            MACRO_NO       AS macroNo,
            MACRO_NAME     AS macroName,
            MACRO_CONTENT  AS macroContent,
            MACRO_TYPE     AS macroType
        FROM MACRO
        WHERE EMPLOYEE_NO = #{employeeNo}
          AND MACRO_TYPE = 'NURSE'
        <if test="keyword != null and keyword != ''">
          AND (MACRO_NAME LIKE '%' || #{keyword} || '%' 
               OR MACRO_CONTENT LIKE '%' || #{keyword} || '%')
        </if>
        ORDER BY MACRO_NO DESC
    </select>
</mapper>